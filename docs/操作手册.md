# HOPE 训练/评估/对比完整操作手册（中文）

## 环境与准备
- Python 3.8+（建议 3.10/3.11）
- 安装依赖：
  - `pip install -r requirements.txt`
  - `pip install -e .`
- 远程 GPU：确保安装 CUDA 版 PyTorch；`python -c "import torch; print(torch.cuda.is_available())"` 应为 `True`
- 可选：开源模型对比（联网）`pip install transformers`；离线对比设置 `HF_HUB_OFFLINE=1`

## 配置（configs/example.yaml）
- 模型规模：`dim`、`depth`、`num_heads`、`ff_mult`、`max_len`
- 记忆与注意力：`memory_capacity`、`top_k`、`error_decay`、`surprise_scale`
- 优化器与稳定性：`lr`、`base_momentum`、`ema_decay`、`optimizer_type`、`grad_clip_norm`、`grad_accum_steps`
- 数据与训练：`batch_size`、`seq_len`、`steps`、`num_workers`、`pin_memory`、`prefetch_factor`
- 嵌套学习调度：`update_frequencies.{mem_write,error_update,optimizer_step}`
- 渐进启用（schedules）：`surprise_scale: {start,end,warmup_steps}`，`mem_write: {start,end,warmup_steps}`
- 设备与混合精度：`cuda_device`、`amp: true|false`、`amp_dtype: bf16|fp16`
- 指标：`metrics.{track_ppl, track_accuracy}`；模型类型：`model_type: hope|baseline`

## 数据准备
- 自动下载 tiny_shakespeare：
  - `hope-prepare-data --out data/tiny_shakespeare.txt --url https://raw.githubusercontent.com/karpathy/char-rnn/master/data/tinyshakespeare/input.txt`
- 或者提供任意 UTF-8 文本路径；所有命令均支持 `--data <path>`。

## 训练（HOPE）
- 随机数据快速验证：`hope-train --config configs/example.yaml`
- 真实文本训练（自动选择设备 + AMP）：
  - `hope-train --config configs/example.yaml --data data/tiny_shakespeare.txt --device auto --amp bf16`
- 强制 GPU 并覆盖步数/批大小/线程：
  - `hope-train --config configs/example.yaml --data data/tiny_shakespeare.txt --device cuda:0 --amp bf16 --steps 10000 --batch_size 32 --workers 4`
- 训练结束保存检查点：`hope_checkpoint.pt`；训练过程显示 `loss/acc/top5/top10`，结束打印 `{loss,ppl,accuracy,top5_acc,top10_acc}`。

## 评估与对比（HOPE vs Baseline）
- 本地对比（验证集 Loss/PPL/Top-k）：
  - `hope-run-experiment --config configs/example.yaml --data data/tiny_shakespeare.txt --device cuda:0 --amp bf16 --workers 4 --download`
  - 生成：`reports/experiment_report.md` 与 `reports/metrics.json`（包含 HOPE 与 Baseline 的训练/验证 `loss/ppl/top5/top10`）
- 离线环境：设置 `HF_HUB_OFFLINE=1` 跳过 HF 对比；本地 HOPE/Baseline 对比与绘图不受影响。
- 快速评估（随机数据）：`hope-eval --ckpt hope_checkpoint.pt`

## 长上下文记忆评测
- 单点评测：`hope-eval-long --gap 2048` → 输出 `{recall_prob: <value>}`
- 批量跟踪：`hope-track-long --ckpt hope_checkpoint.pt --device cuda:0 --gaps 256,512,1024,2048` → `reports/long_context.csv`

## 推理（文本生成）
- `hope-infer --ckpt hope_checkpoint.pt --prompt "Hello, HOPE!" --max_new_tokens 200`
- 字节级分词器无需额外词表，`vocab_size=256`，生成直接打印到终端。

## 元学习外循环（可选）
- 外循环训练：`hope-meta-train --config configs/example.yaml --data data/tiny_shakespeare.txt --device cuda:0 --download`
- 配置项：`meta.{use, inner_steps, outer_steps, outer_frequency}`；训练期间对验证集进行 `meta_update`。

## 持续学习与灾难性遗忘评测
- 顺序训练 A→B→C：`hope-continual --config configs/example.yaml --data data/tiny_shakespeare.txt --device cuda:0 --steps_per_stage 1000`
- 每阶段训练后对 A/B/C 验证，报告保存到 `reports/continual_metrics.json` 与 `reports/continual_report.md`。

## 更丰富的评测指标
- Top-k 准确率：训练进度条显示 `top5/top10`；训练结束与评估输出平均值。
- 长度分段困惑度：`hope-eval-binned --ckpt hope_checkpoint.pt --device cuda:0 --data data/tiny_shakespeare.txt --lengths 64,128,256,512` → `reports/binned_ppl.csv`

## 自动绘图（报告图表）
- 生成三张图：
  - Recall 曲线：`reports/recall_curve.png`（来自 `reports/long_context.csv`）
  - Binned PPL 柱状图：`reports/binned_ppl.png`（来自 `reports/binned_ppl.csv`）
  - HOPE vs Baseline 对比条形图：`reports/compare_metrics.png`（来自 `reports/metrics.json`）
- 命令：`hope-plot-reports --recall_csv reports/long_context.csv --binned_csv reports/binned_ppl.csv --metrics_json reports/metrics.json --out_dir reports`

## 常见问题与建议
- 显存不足：降低 `dim/depth/batch_size/seq_len`；适当降低 `memory_capacity/top_k`；使用 `grad_accum_steps`。
- 训练不稳定：增大 `error_decay`、降低 `surprise_scale`，或提高 `ema_decay/base_momentum`；开启 `grad_clip_norm`。
- 维度不匹配：确保 `dim % num_heads == 0`，`max_len >= seq_len`。
- ImportError：修改代码后执行 `pip install -e .` 刷新入口；检查 Python `sys.path`。
- 梯度报错（inplace）：设置 `debug_anomaly: true` 定位；注意已在注意力/惊讶信号处做 `clone()/detach()` 保护。
- GPU 利用率低：确认 `--device cuda[:id]` 或 `--device auto`；安装 CUDA 版 PyTorch；提高 `--workers`；启用 AMP `--amp bf16|fp16`。
- HF 网络问题：设置 `HF_HUB_OFFLINE=1` 跳过开源对比；本地对比与绘图不受影响。

## 实验报告与一键流程
- 报告文件：`reports/experiment_report.md`、`reports/metrics.json`；图表：`reports/recall_curve.png`、`reports/binned_ppl.png`、`reports/compare_metrics.png`
- 一键完整流程（训练→评估→对比→绘图）：
  1) 数据：
     - `hope-prepare-data --out data/tiny_shakespeare.txt --url https://raw.githubusercontent.com/karpathy/char-rnn/master/data/tinyshakespeare/input.txt`
  2) 训练：
     - `hope-train --config configs/example.yaml --data data/tiny_shakespeare.txt --device cuda:0 --amp bf16 --steps 10000 --batch_size 32 --workers 4`
  3) 对比评测：
     - `hope-run-experiment --config configs/example.yaml --data data/tiny_shakespeare.txt --device cuda:0 --amp bf16 --workers 4 --download`
  4) 长上下文与分段：
     - `hope-track-long --ckpt hope_checkpoint.pt --device cuda:0 --gaps 256,512,1024,2048`
     - `hope-eval-binned --ckpt hope_checkpoint.pt --device cuda:0 --data data/tiny_shakespeare.txt --lengths 64,128,256,512`
  5) 自动绘图：
     - `hope-plot-reports --recall_csv reports/long_context.csv --binned_csv reports/binned_ppl.csv --metrics_json reports/metrics.json --out_dir reports`
